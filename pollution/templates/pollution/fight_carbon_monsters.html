{% extends 'Sustain/base.html' %}
{%load static%}
{% block content %}
    <!--
    File: fight_carbon_monsters.html

    Description: This HTML file represents the template for the "Fight Carbon Monsters" page of the Sustainability Game. It extends the 'Sustain/base.html' template and includes static files for styling.
    The page displays a monster's name, health bar, image, and an input box for attack points. The user can commit a certain number of points to attack the monster by clicking the "FIGHT" button. After clicking the button, a modal with a spinning wheel appears, and the wheel randomly selects a winning section. The attack damage is calculated based on the winning section, and the health bar is updated accordingly.
    The file also includes JavaScript code to handle the functionality of the page, such as updating the health bar, showing and hiding the modal, spinning the wheel, and calculating the attack damage.
    Note: The file contains Django template tags (e.g., {% extends %}, {% load %}, {% block %}, {% static %}, {{ variable }}) for rendering dynamic content and CSRF protection.

    Author: Will
    -->
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/fight_monsters.css' %}">
</head>
<body>
    
    <div class="notice">
        Fight! Destroy this monster and help save the planet 
    </div>
    <div class="monster-name">
        Name: {{monster.monster_name}}
    </div>
    <div class="health-bar" 
         data-initial-health="{{ monster.initial_health_points }}" 
         data-health="{{ monster.health_points }}">
        <div class="health-remaining" style="width: 0%">
            {{ monster.health_points }} / {{ monster.initial_health_points }}
        </div>
    </div>
    <div class="image-box">
        <img src="{% static 'img/muk.jpg' %}" alt="Image description">
    </div>
    <!-- Input box for attack points -->

    <div class = "notice">
        <label for="attack-points">Your total points are : {{user.pointsToAttack}}</label>
    </div> 

    <div class = "notice">
        
        <label for="attack-points">How many points would you like to commit to this attack?</label>
        <input type="number" id="attack-points" required>
    </div>

    
   
    <button class="fight-button">FIGHT</button>
  
    <div class="modal-bg" id="modal-bg">
        <!-- Modal content -->
        <div class="modal-content">
            <!-- Spinning wheel -->
            |
            <div class="wheel" id="wheel">
                <div class="section">green</div>
                <div class="section">red</div>
                <div class="section">blue</div>
                <!-- Add more sections as needed -->
            </div>
            <button class="spin-button" onclick="spinWheel()">Spin</button> 
        </div>
    </div>
</body>
  
  <script>
   document.addEventListener("DOMContentLoaded", function() {



    // Function to update health bar width
    function updateHealthBar() {
        // Get the health bar element
        var healthBar = document.querySelector('.health-bar');
        // Get initial health and current health from data attributes
        var initialHealth = parseInt(healthBar.getAttribute('data-initial-health'));
        var health = parseInt(healthBar.getAttribute('data-health'));
        // Calculate the percentage width based on the monster's health points
        var percentageWidth = (health / initialHealth) * 100;
        // Set the width of the health bar dynamically
        var healthRemaining = healthBar.querySelector('.health-remaining');
        healthRemaining.style.width = percentageWidth + '%';
    }

    // Attach event listener to the fight button
        var fightButton = document.querySelector('.fight-button');
        var healthBar = document.querySelector('.health-bar');
        var currentHealth = parseInt(healthBar.getAttribute('data-health'));

        fightButton.addEventListener('click', function() {
        showModal();
        
        currentHealth = parseInt(healthBar.getAttribute('data-health'));
        

        currentHealth -= 10; // Decrease health by 10
        healthBar.setAttribute('data-health', currentHealth); // Update data attribute
        
        // Call the function to update the health bar width
        updateHealthBar();

       
    });

    // Call the function to update the health bar width initially
    updateHealthBar();
    });

    function showModal() {
        document.getElementById('modal-bg').style.display = 'block';
    }
    
    function hideModal() {
        document.getElementById('modal-bg').style.display = 'none';
    }
    
    function spinWheel() {
        
        var wheel = document.getElementById('wheel');
        var sections = wheel.querySelectorAll('.section');

        // Randomly select the winning section
        var randomIndex = Math.floor(Math.random() * sections.length);
        var winningSection = sections[randomIndex];

        // Calculate rotation angle for the spinning animation
        var totalSections = sections.length;
        var angle = 360 / totalSections;
        var rotationAngle = (randomIndex * angle) + 360 * 5; // Add extra rotations

        attackDamage = document.getElementById('attack-points').value;
        // Apply rotation animation to the wheel
       
        wheel.style.transition = 'transform 3s ease-in-out';
        wheel.style.transform = 'rotate(' + rotationAngle + 'deg)';
        doDamage(winningSection);


        // After spinning animation ends, show the winning outcome
        setTimeout(function() {
          alert("Sections is:" + winningSection.textContent)
           hideModal();
      
            }, 3000); // 3000ms = 3s, adjust accordingly
        }



        function doDamage(winningSection){
            //const csrfToken = cookies.get('csrftoken');
            var formData = new FormData();
            var csrfToken = '{{ csrf_token }}';
            
            //If it is green there is no need to change
            if(winningSection.textContent == "red"){
                attackDamage *=2;
            }else if(winningSection.textContent == "blue"){
                attackDamage *=3;
            }
            if(attackDamage <'{{user.pointsToAttack}}'){
                formData.append('id', 2); // Use the monster ID from your template
                formData.append('attackStrength', attackDamage);
                formData.append('csrfmiddlewaretoken', csrfToken)
            
                fetch('damage_carbon_monsters', {
                method: 'POST',
                body: formData,    
            })    
            }else{
                alert("Too little points")
            }




            
        }
</script>
</body>

{% endblock %}